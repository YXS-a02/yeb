<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤šåª’ä½“æ’­æ”¾å™¨</title>
    <style>
        :root {
            --primary-color: #00ff9d;
            --background-dark: #1a1a1a;
            --background-medium: #252525;
            --background-light: #333;
            --text-color: #fff;
            --text-secondary: #ccc;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: var(--background-dark);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .player-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .sidebar {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        
        .player-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
        }
        
        #mediaElement {
            width: 100%;
            border-radius: 10px 10px 0 0;
            background: #000;
            max-height: 480px;
            display: block;
            z-index: 2;
            position: relative;
        }
        
        .cover-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 1;
            transition: opacity 0.3s;
            border-radius: 10px 10px 0 0;
        }
        
        .cover-layer.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .cover-layer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .cover-placeholder {
            font-size: 5rem;
            color: #444;
        }
        
        .controls {
            padding: 15px;
            background: var(--background-medium);
            border-radius: 0 0 10px 10px;
            z-index: 3;
            position: relative;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: #555;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 3px;
            position: relative;
        }
        
        #progressBar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            border-radius: 3px;
            transition: width 0.2s ease;
        }
        
        .button-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-icon {
            font-size: 1.2rem;
            width: 24px;
            height: 24px;
        }
        
        input[type="range"] {
            width: 100px;
            height: 4px;
            accent-color: var(--primary-color);
        }
        
        .time-display {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin: 0 10px;
        }
        
        .media-info {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: var(--background-medium);
            border-radius: 10px;
        }
        
        .info-text {
            flex: 1;
        }
        
        .info-text h3 {
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .info-text p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .id3-info {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .id3-info div {
            margin-bottom: 3px;
        }
        
        .api-management {
            margin-bottom: 15px;
        }
        
        .api-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        select {
            flex: 1;
            padding: 8px 12px;
            border-radius: 5px;
            background: var(--background-medium);
            color: var(--text-color);
            border: 1px solid #444;
        }
        
        .api-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }
        
        input[type="text"] {
            padding: 8px 12px;
            border-radius: 5px;
            background: var(--background-medium);
            color: var(--text-color);
            border: 1px solid #444;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: #000;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background: #00e58c;
        }
        
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-list h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .file-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .file-item.active {
            background: var(--primary-color);
            color: #000;
        }
        
        .file-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .error-message {
            color: #ff6b6b;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 5px;
            margin: 10px 0;
        }
        
        /* éšè—é»˜è®¤æ§ä»¶ */
        video::-webkit-media-controls {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-section">
            <div class="player-container card">
                <div class="cover-layer" id="coverLayer">
                    <div class="cover-placeholder" id="coverPlaceholder">ğŸµ</div>
                    <img id="coverArt" style="display: none;" alt="å°é¢">
                </div>
                <video id="mediaElement" controls="false"></video>
                <div class="controls">
                    <div class="progress-container" id="progressContainer">
                        <div id="progressBar"></div>
                    </div>
                    <div class="button-container">
                        <button id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">
                            <span class="btn-icon">â–¶</span>
                        </button>
                        <button id="toggleCoverBtn" title="æ˜¾ç¤º/éšè—å°é¢">
                            <span class="btn-icon">ğŸ–¼ï¸</span>
                        </button>
                        <span class="time-display">
                            <span id="currentTime">0:00</span> / 
                            <span id="duration">0:00</span>
                        </span>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" title="éŸ³é‡">
                        <select id="playbackRate" title="æ’­æ”¾é€Ÿåº¦">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                        <button id="fullscreenBtn" title="å…¨å±">
                            <span class="btn-icon">â¤¢</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="media-info card">
                <div class="info-text">
                    <h3 id="mediaTitle">é€‰æ‹©åª’ä½“æ–‡ä»¶å¼€å§‹æ’­æ”¾</h3>
                    <p id="mediaMeta">--</p>
                    <div class="id3-info" id="id3Info"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="api-management card">
                <h3>API ç®¡ç†</h3>
                <div class="api-selector">
                    <select id="apiSelector">
                        <option value="./api.php">é»˜è®¤ API (api.php)</option>
                    </select>
                    <button id="refreshApiBtn" title="åˆ·æ–°API" class="btn-primary">â†»</button>
                </div>
                <div class="api-form">
                    <input type="text" id="newApiInput" placeholder="è¾“å…¥API URL">
                    <button id="addApiBtn" class="btn-primary">æ·»åŠ </button>
                </div>
                <div id="apiError" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="file-list card">
                <h3>
                    <span>åª’ä½“æ–‡ä»¶åˆ—è¡¨</span>
                    <span id="loadingIndicator" style="display:none;">åŠ è½½ä¸­...</span>
                </h3>
                <div id="fileItems">
                    <div class="empty-state">è¯·é€‰æ‹©APIå¹¶åˆ·æ–°åˆ—è¡¨</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let db = null;
        let currentApi = './api.php';
        let currentMediaInfo = null;
        let isCoverVisible = true;
        let isDbReady = false;
        
        // DOMå…ƒç´ 
        const mediaElement = document.getElementById('mediaElement');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeDisplay = document.getElementById('currentTime');
        const durationDisplay = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const playbackRate = document.getElementById('playbackRate');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const fileItemsContainer = document.getElementById('fileItems');
        const apiSelector = document.getElementById('apiSelector');
        const refreshApiBtn = document.getElementById('refreshApiBtn');
        const newApiInput = document.getElementById('newApiInput');
        const addApiBtn = document.getElementById('addApiBtn');
        const coverArt = document.getElementById('coverArt');
        const coverLayer = document.getElementById('coverLayer');
        const coverPlaceholder = document.getElementById('coverPlaceholder');
        const toggleCoverBtn = document.getElementById('toggleCoverBtn');
        const mediaTitle = document.getElementById('mediaTitle');
        const mediaMeta = document.getElementById('mediaMeta');
        const id3Info = document.getElementById('id3Info');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const apiError = document.getElementById('apiError');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initDatabase();
            setupEventListeners();
            
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªAPIçš„æ–‡ä»¶åˆ—è¡¨
            setTimeout(() => {
                refreshFileList();
            }, 500);
        });
        
        // åˆå§‹åŒ–IndexedDB
        function initDatabase() {
            try {
                // å…ˆå°è¯•æ‰“å¼€æ•°æ®åº“è€Œä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä»¥è·å–å½“å‰ç‰ˆæœ¬
                const versionRequest = indexedDB.open('MediaPlayerDB');
                
                versionRequest.onsuccess = (event) => {
                    const tempDb = event.target.result;
                    const currentVersion = tempDb.version;
                    tempDb.close();
                    
                    // ä½¿ç”¨å½“å‰ç‰ˆæœ¬+1æ¥æ‰“å¼€æ•°æ®åº“ï¼Œé¿å…ç‰ˆæœ¬å†²çª
                    const dbVersion = currentVersion + 1;
                    console.log('å½“å‰æ•°æ®åº“ç‰ˆæœ¬:', currentVersion, 'ï¼Œä½¿ç”¨ç‰ˆæœ¬:', dbVersion);
                    
                    // ä½¿ç”¨æ–°ç‰ˆæœ¬æ‰“å¼€æ•°æ®åº“
                    const request = indexedDB.open('MediaPlayerDB', dbVersion);
                    
                    request.onerror = (event) => {
                        console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥:', event.target.error);
                        // å¦‚æœç‰ˆæœ¬å‡çº§å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å½“å‰ç‰ˆæœ¬
                        fallbackOpenDatabase(currentVersion);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        console.log('æ•°æ®åº“å‡çº§éœ€è¦ï¼Œç‰ˆæœ¬:', event.oldVersion, '->', event.newVersion);
                        db = event.target.result;
                        
                        // åˆ›å»ºæˆ–æ›´æ–°å¯¹è±¡å­˜å‚¨
                        if (!db.objectStoreNames.contains('apis')) {
                            const apiStore = db.createObjectStore('apis', { keyPath: 'id', autoIncrement: true });
                            apiStore.createIndex('url', 'url', { unique: true });
                            console.log('åˆ›å»ºapiså¯¹è±¡å­˜å‚¨');
                        }
                        
                        if (!db.objectStoreNames.contains('history')) {
                            const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                            historyStore.createIndex('timestamp', 'timestamp', { unique: false });
                            console.log('åˆ›å»ºhistoryå¯¹è±¡å­˜å‚¨');
                        }
                    };
                    
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        isDbReady = true;
                        console.log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼Œç‰ˆæœ¬:', db.version);
                        
                        db.onversionchange = () => {
                            db.close();
                            console.log('æ•°æ®åº“å·²æ›´æ–°ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢');
                            showError('æ•°æ®åº“å·²æ›´æ–°ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢');
                        };
                        
                        loadApiList();
                    };
                };
                
                versionRequest.onerror = (event) => {
                    console.error('è·å–æ•°æ®åº“ç‰ˆæœ¬å¤±è´¥:', event.target.error);
                    // å¦‚æœæ— æ³•è·å–ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬1
                    fallbackOpenDatabase(1);
                };
            } catch (error) {
                console.error('æ•°æ®åº“åˆå§‹åŒ–å¼‚å¸¸:', error);
                isDbReady = false;
                showError('æ•°æ®åº“åˆå§‹åŒ–å¼‚å¸¸: ' + error.message);
            }
        }
        
        // å¤‡ç”¨æ•°æ®åº“æ‰“å¼€æ–¹æ³•
        function fallbackOpenDatabase(version) {
            try {
                const request = indexedDB.open('MediaPlayerDB', version);
                
                request.onerror = (event) => {
                    console.error('å¤‡ç”¨æ•°æ®åº“æ‰“å¼€å¤±è´¥:', event.target.error);
                    isDbReady = false;
                    showError('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ' + (event.target.error?.message || 'æœªçŸ¥é”™è¯¯'));
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    isDbReady = true;
                    console.log('å¤‡ç”¨æ•°æ®åº“æ‰“å¼€æˆåŠŸï¼Œç‰ˆæœ¬:', db.version);
                    loadApiList();
                };
            } catch (error) {
                console.error('å¤‡ç”¨æ•°æ®åº“æ‰“å¼€å¼‚å¸¸:', error);
                isDbReady = false;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            apiError.textContent = message;
            apiError.style.display = 'block';
            setTimeout(() => {
                apiError.style.display = 'none';
            }, 5000);
        }
        
        // åŠ è½½APIåˆ—è¡¨
        function loadApiList() {
            if (!isDbReady || !db) {
                console.log('æ•°æ®åº“æœªå°±ç»ªï¼Œä½¿ç”¨é»˜è®¤API');
                return;
            }
            
            if (!db.objectStoreNames.contains('apis')) {
                console.error('apiså¯¹è±¡å­˜å‚¨ä¸å­˜åœ¨');
                return;
            }
            
            try {
                const transaction = db.transaction(['apis'], 'readonly');
                const store = transaction.objectStore('apis');
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const apis = event.target.result;
                    apiSelector.innerHTML = '<option value="./api.php">é»˜è®¤ API (api.php)</option>';
                    
                    apis.forEach(api => {
                        const option = document.createElement('option');
                        option.value = api.url;
                        option.textContent = api.name || api.url;
                        option.selected = api.url === currentApi;
                        apiSelector.appendChild(option);
                    });
                };
                
                request.onerror = (event) => {
                    console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', event.target.error);
                };
            } catch (error) {
                console.error('è®¿é—®æ•°æ®åº“å¤±è´¥:', error);
            }
        }
        
        // æ·»åŠ API
        function addApi() {
            const url = newApiInput.value.trim();
            if (!url) {
                showError('è¯·è¾“å…¥API URL');
                return;
            }
            
            if (!isDbReady || !db) {
                showError('æ•°æ®åº“æœªå°±ç»ªï¼Œæ— æ³•æ·»åŠ API');
                return;
            }
            
            if (!db.objectStoreNames.contains('apis')) {
                showError('æ•°æ®åº“ç»“æ„é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            try {
                const transaction = db.transaction(['apis'], 'readwrite');
                const store = transaction.objectStore('apis');
                const request = store.add({ url, name: url, added: new Date() });
                
                request.onsuccess = (event) => {
                    newApiInput.value = '';
                    loadApiList();
                    console.log('APIæ·»åŠ æˆåŠŸ');
                };
                
                request.onerror = (event) => {
                    console.error('æ·»åŠ APIå¤±è´¥:', event.target.error);
                    if (event.target.error.name === 'ConstraintError') {
                        showError('è¯¥APIå·²å­˜åœ¨');
                    } else {
                        showError('æ·»åŠ APIå¤±è´¥: ' + event.target.error.message);
                    }
                };
            } catch (error) {
                console.error('è®¿é—®æ•°æ®åº“å¤±è´¥:', error);
                showError('è®¿é—®æ•°æ®åº“å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        function refreshFileList() {
            const apiUrl = apiSelector.value;
            if (!apiUrl) return;
            
            currentApi = apiUrl;
            loadingIndicator.style.display = 'block';
            fileItemsContainer.innerHTML = '';
            
            console.log('æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼ŒAPI:', apiUrl);
            
            fetch(`${apiUrl}?event=lmf`)
                .then(response => {
                    console.log('æ–‡ä»¶åˆ—è¡¨å“åº”çŠ¶æ€:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    console.log('æ–‡ä»¶åˆ—è¡¨æ•°æ®:', data);
                    
                    if (data.error) {
                        fileItemsContainer.innerHTML = `<div class="error-message">é”™è¯¯: ${data.error}</div>`;
                        return;
                    }
                    
                    if (!data.files || data.files.length === 0) {
                        fileItemsContainer.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°åª’ä½“æ–‡ä»¶</div>';
                        return;
                    }
                    
                    data.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.dataset.path = file.path;
                        
                        const icon = document.createElement('div');
                        icon.className = 'file-icon';
                        icon.innerHTML = file.type === 'audio' ? 'ğŸµ' : 'ğŸ¬';
                        
                        const name = document.createElement('div');
                        name.className = 'file-name';
                        name.textContent = file.name;
                        
                        fileItem.appendChild(icon);
                        fileItem.appendChild(name);
                        
                        fileItem.addEventListener('click', () => {
                            document.querySelectorAll('.file-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            
                            fileItem.classList.add('active');
                            
                            playMediaFile(file.path, file.name);
                            
                            fetchMediaInfo(file.path);
                        });
                        
                        fileItemsContainer.appendChild(fileItem);
                    });
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    fileItemsContainer.innerHTML = `<div class="error-message">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // è·å–åª’ä½“æ–‡ä»¶ä¿¡æ¯
        function fetchMediaInfo(filePath) {
            console.log('è·å–åª’ä½“ä¿¡æ¯:', filePath);
            
            fetch(`${currentApi}?event=mfi&file=${encodeURIComponent(filePath)}`)
                .then(response => {
                    console.log('åª’ä½“ä¿¡æ¯å“åº”çŠ¶æ€:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('åª’ä½“ä¿¡æ¯æ•°æ®:', data);
                    
                    if (data.error) {
                        console.error('è·å–åª’ä½“ä¿¡æ¯å¤±è´¥:', data.error);
                        return;
                    }
                    
                    currentMediaInfo = data;
                    updateMediaInfoDisplay(data);
                    
                    // è·å–å°é¢
                    fetchCover(data.path);
                    
                    // è·å–ID3ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶ï¼‰
                    if (data.type === 'audio') {
                        fetchID3Info(data.path);
                    } else {
                        id3Info.innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('è·å–åª’ä½“ä¿¡æ¯å¤±è´¥:', error);
                });
        }
        
        // æ›´æ–°åª’ä½“ä¿¡æ¯æ˜¾ç¤º
        function updateMediaInfoDisplay(info) {
            mediaTitle.textContent = info.name;
            
            const sizeMB = (info.size / (1024 * 1024)).toFixed(2);
            
            let durationText = '--';
            if (info.duration) {
                durationText = formatTime(info.duration);
            }
            
            mediaMeta.textContent = `${info.type.toUpperCase()} | ${sizeMB} MB | ${durationText}`;
        }
        
        // è·å–ID3ä¿¡æ¯
        function fetchID3Info(filePath) {
            console.log('è·å–ID3ä¿¡æ¯:', filePath);
            
            fetch(`${currentApi}?event=id3&file=${encodeURIComponent(filePath)}`)
                .then(response => {
                    console.log('ID3ä¿¡æ¯å“åº”çŠ¶æ€:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ID3ä¿¡æ¯æ•°æ®:', data);
                    
                    if (data.error) {
                        console.log('æ²¡æœ‰ID3ä¿¡æ¯:', data.error);
                        id3Info.innerHTML = '';
                        return;
                    }
                    
                    // æ˜¾ç¤ºID3ä¿¡æ¯
                    let id3Html = '';
                    if (data.title) id3Html += `<div><strong>æ ‡é¢˜:</strong> ${data.title}</div>`;
                    if (data.artist) id3Html += `<div><strong>è‰ºæœ¯å®¶:</strong> ${data.artist}</div>`;
                    if (data.album) id3Html += `<div><strong>ä¸“è¾‘:</strong> ${data.album}</div>`;
                    if (data.year) id3Html += `<div><strong>å¹´ä»½:</strong> ${data.year}</div>`;
                    if (data.genre) id3Html += `<div><strong>æµæ´¾:</strong> ${data.genre}</div>`;
                    
                    id3Info.innerHTML = id3Html;
                })
                .catch(error => {
                    console.log('è·å–ID3ä¿¡æ¯å¤±è´¥:', error.message);
                    id3Info.innerHTML = '';
                });
        }
        
        // è·å–å°é¢
        function fetchCover(filePath) {
            console.log('è·å–å°é¢:', filePath);
            
            // é‡ç½®å°é¢æ˜¾ç¤º
            coverArt.style.display = 'none';
            coverPlaceholder.style.display = 'block';
            
            // å¦‚æœæœ‰ä¹‹å‰çš„Blob URLï¼Œé‡Šæ”¾å®ƒ
            if (coverArt.src && coverArt.src.startsWith('blob:')) {
                URL.revokeObjectURL(coverArt.src);
            }
            
            // é‡ç½®å°é¢æº
            coverArt.src = '';
            
            // æ„å»ºå°é¢URL
            const coverUrl = `${currentApi}?event=mfp&file=${encodeURIComponent(filePath)}`;
            console.log('å°é¢URL:', coverUrl);
            
            fetch(coverUrl)
                .then(response => {
                    console.log('å°é¢å“åº”çŠ¶æ€:', response.status, response.statusText);
                    console.log('å°é¢å“åº”å¤´:', {
                        'content-type': response.headers.get('content-type'),
                        'content-length': response.headers.get('content-length')
                    });
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.startsWith('image/')) {
                            return response.blob();
                        } else {
                            throw new Error(`å“åº”ä¸æ˜¯å›¾ç‰‡ç±»å‹: ${contentType}`);
                        }
                    } else {
                        throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                    }
                })
                .then(blob => {
                    console.log('å°é¢Blob:', blob);
                    if (blob && blob.size > 0) {
                        const url = URL.createObjectURL(blob);
                        console.log('åˆ›å»ºBlob URL:', url);
                        
                        // è®¾ç½®å°é¢å›¾ç‰‡
                        coverArt.onload = () => {
                            console.log('å°é¢å›¾ç‰‡åŠ è½½æˆåŠŸ');
                            coverArt.style.display = 'block';
                            coverPlaceholder.style.display = 'none';
                            
                            // å¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶ï¼Œç¡®ä¿å°é¢å±‚å¯è§
                            if (currentMediaInfo && currentMediaInfo.type === 'audio') {
                                coverLayer.classList.remove('hidden');
                            }
                        };
                        
                        coverArt.onerror = (e) => {
                            console.error('å°é¢å›¾ç‰‡åŠ è½½å¤±è´¥:', e);
                            coverArt.style.display = 'none';
                            coverPlaceholder.style.display = 'block';
                        };
                        
                        coverArt.src = url;
                    } else {
                        throw new Error('å°é¢æ•°æ®ä¸ºç©ºæˆ–å¤§å°ä¸º0');
                    }
                })
                .catch(error => {
                    console.error('è·å–å°é¢å¤±è´¥:', error.message);
                    coverArt.style.display = 'none';
                    coverPlaceholder.style.display = 'block';
                });
        }
        
        // æ’­æ”¾åª’ä½“æ–‡ä»¶
        function playMediaFile(filePath, fileName) {
            const url = `${currentApi}?event=mf&file=${encodeURIComponent(filePath)}`;
            console.log('æ’­æ”¾åª’ä½“æ–‡ä»¶:', url);
            
            // é‡ç½®åª’ä½“å…ƒç´ 
            mediaElement.src = url;
            
            // é‡ç½®ID3ä¿¡æ¯æ˜¾ç¤º
            id3Info.innerHTML = '';
            
            mediaElement.play()
                .then(() => {
                    console.log('åª’ä½“æ’­æ”¾å¼€å§‹');
                    playPauseBtn.innerHTML = '<span class="btn-icon">â¸</span>';
                    addToPlaybackHistory(filePath, fileName);
                    
                    // å¦‚æœæ˜¯éŸ³é¢‘ï¼Œæ˜¾ç¤ºå°é¢ï¼›å¦‚æœæ˜¯è§†é¢‘ï¼Œéšè—å°é¢
                    if (currentMediaInfo && currentMediaInfo.type === 'audio') {
                        coverLayer.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('æ’­æ”¾å¤±è´¥:', error);
                    showError('æ’­æ”¾å¤±è´¥: ' + error.message);
                });
        }
        
        // æ·»åŠ åˆ°æ’­æ”¾å†å²ï¼ˆè®°å½•ä½†ä¸æ˜¾ç¤ºï¼‰
        function addToPlaybackHistory(filePath, fileName) {
            if (!isDbReady || !db) return;
            
            if (!db.objectStoreNames.contains('history')) {
                console.error('historyå¯¹è±¡å­˜å‚¨ä¸å­˜åœ¨');
                return;
            }
            
            const timestamp = new Date();
            const historyItem = {
                filePath,
                fileName,
                timestamp: timestamp.getTime(),
                displayTime: timestamp.toLocaleString()
            };
            
            try {
                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                const request = store.add(historyItem);
                
                request.onsuccess = () => {
                    console.log('æ’­æ”¾å†å²å·²è®°å½•');
                };
                
                request.onerror = (event) => {
                    console.error('ä¿å­˜æ’­æ”¾å†å²å¤±è´¥:', event.target.error);
                };
            } catch (error) {
                console.error('è®¿é—®æ•°æ®åº“å¤±è´¥:', error);
            }
        }
        
        // ä¿®å¤è¿›åº¦æ¡ç‚¹å‡»è·³è½¬åŠŸèƒ½
        function setupProgressBarClick() {
            progressContainer.addEventListener('click', (e) => {
                // ç¡®ä¿åª’ä½“å·²åŠ è½½ä¸”æœ‰æ—¶é•¿
                if (!mediaElement.src || isNaN(mediaElement.duration) || mediaElement.duration <= 0) {
                    console.log('åª’ä½“æœªåŠ è½½å®Œæˆï¼Œæ— æ³•è·³è½¬');
                    return;
                }
                
                const rect = progressContainer.getBoundingClientRect();
                // è®¡ç®—ç‚¹å‡»ä½ç½®åœ¨è¿›åº¦æ¡ä¸Šçš„ç™¾åˆ†æ¯”
                const clickPosition = (e.clientX - rect.left) / rect.width;
                // ç¡®ä¿ç™¾åˆ†æ¯”åœ¨0-1ä¹‹é—´
                const percent = Math.max(0, Math.min(1, clickPosition));
                // è®¡ç®—å¯¹åº”çš„æ’­æ”¾æ—¶é—´
                const newTime = percent * mediaElement.duration;
                
                console.log(`è·³è½¬åˆ°: ${newTime.toFixed(2)} ç§’ (${percent.toFixed(2)}%)`);
                
                // è®¾ç½®æ–°çš„æ’­æ”¾æ—¶é—´
                mediaElement.currentTime = newTime;
                
                // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                progressBar.style.width = `${percent * 100}%`;
            });
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ’­æ”¾/æš‚åœæ§åˆ¶
            playPauseBtn.addEventListener('click', () => {
                if (mediaElement.paused) {
                    mediaElement.play();
                    playPauseBtn.innerHTML = '<span class="btn-icon">â¸</span>';
                } else {
                    mediaElement.pause();
                    playPauseBtn.innerHTML = '<span class="btn-icon">â–¶</span>';
                }
            });
            
            // åˆ‡æ¢å°é¢æ˜¾ç¤º/éšè—
            toggleCoverBtn.addEventListener('click', () => {
                isCoverVisible = !isCoverVisible;
                if (isCoverVisible) {
                    coverLayer.classList.remove('hidden');
                } else {
                    coverLayer.classList.add('hidden');
                }
            });
            
            // è¿›åº¦æ¡æ›´æ–°
            mediaElement.addEventListener('timeupdate', () => {
                // ç¡®ä¿æœ‰æœ‰æ•ˆçš„æ—¶é•¿
                if (mediaElement.duration && mediaElement.duration > 0) {
                    const progress = (mediaElement.currentTime / mediaElement.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                    currentTimeDisplay.textContent = formatTime(mediaElement.currentTime);
                }
            });
            
            // è®¾ç½®è¿›åº¦æ¡ç‚¹å‡»äº‹ä»¶
            setupProgressBarClick();
            
            // éŸ³é‡æ§åˆ¶
            volumeSlider.addEventListener('input', (e) => {
                mediaElement.volume = e.target.value;
            });
            
            // æ’­æ”¾é€Ÿåº¦æ§åˆ¶
            playbackRate.addEventListener('change', (e) => {
                mediaElement.playbackRate = e.target.value;
            });
            
            // å…¨å±æ§åˆ¶
            fullscreenBtn.addEventListener('click', () => {
                if (mediaElement.requestFullscreen) {
                    mediaElement.requestFullscreen();
                } else if (mediaElement.webkitRequestFullscreen) {
                    mediaElement.webkitRequestFullscreen();
                } else if (mediaElement.msRequestFullscreen) {
                    mediaElement.msRequestFullscreen();
                }
            });
            
            // APIé€‰æ‹©å˜åŒ–
            apiSelector.addEventListener('change', () => {
                refreshFileList();
            });
            
            // åˆ·æ–°APIæŒ‰é’®
            refreshApiBtn.addEventListener('click', () => {
                refreshFileList();
            });
            
            // æ·»åŠ APIæŒ‰é’®
            addApiBtn.addEventListener('click', addApi);
            
            // æŒ‰Enteræ·»åŠ API
            newApiInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addApi();
                }
            });
            
            // åˆå§‹åŒ–æŒç»­æ—¶é—´æ˜¾ç¤º
            mediaElement.addEventListener('loadedmetadata', () => {
                if (mediaElement.duration && mediaElement.duration > 0) {
                    durationDisplay.textContent = formatTime(mediaElement.duration);
                    
                    // è§†é¢‘åŠ è½½å®Œæˆåéšè—å°é¢
                    if (currentMediaInfo && currentMediaInfo.type === 'video') {
                        coverLayer.classList.add('hidden');
                    }
                }
            });
            
            // åª’ä½“ç»“æŸäº‹ä»¶
            mediaElement.addEventListener('ended', () => {
                playPauseBtn.innerHTML = '<span class="btn-icon">â–¶</span>';
            });
            
            // åª’ä½“åŠ è½½é”™è¯¯å¤„ç†
            mediaElement.addEventListener('error', () => {
                console.error('åª’ä½“åŠ è½½é”™è¯¯');
                showError('åª’ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç½‘ç»œè¿æ¥');
            });
        }
        
        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>