<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤šåª’ä½“æ’­æ”¾å™¨</title>
    <link rel="stylesheet" href="./0.css">
</head>
<body>
    <div class="container">
        <div class="player-section">
            <div class="player-container card">
                <div class="cover-layer" id="coverLayer">
                    <div class="cover-placeholder" id="coverPlaceholder">ğŸµ</div>
                    <img id="coverArt" style="display: none;" alt="å°é¢">
                </div>
                <video id="mediaElement" controls="false"></video>
                <div class="controls">
                    <div class="progress-container" id="progressContainer">
                        <div id="progressBar"></div>
                    </div>
                    <div class="button-container">
                        <button id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">
                            <span class="btn-icon">â–¶</span>
                        </button>
                        <button id="toggleCoverBtn" title="æ˜¾ç¤º/éšè—å°é¢">
                            <span class="btn-icon">ğŸ–¼ï¸</span>
                        </button>
                        <span class="time-display">
                            <span id="currentTime">0:00</span> / 
                            <span id="duration">0:00</span>
                        </span>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" title="éŸ³é‡">
                        <select id="playbackRate" title="æ’­æ”¾é€Ÿåº¦">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                        <button id="fullscreenBtn" title="å…¨å±">
                            <span class="btn-icon">â¤¢</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="media-info card">
                <div class="info-text">
                    <h3 id="mediaTitle">é€‰æ‹©åª’ä½“æ–‡ä»¶å¼€å§‹æ’­æ”¾</h3>
                    <p id="mediaMeta">--</p>
                    <div class="id3-info" id="id3Info"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="api-management card">
                <h3>API ç®¡ç†</h3>
                <div class="api-selector">
                    <select id="apiSelector">
                        <option value="./api.php">é»˜è®¤ API (api.php)</option>
                    </select>
                </div>
                <div class="api-form">
                    <button id="refreshApiBtn" title="åˆ·æ–°API" class="btn-primary">â†»</button>
                    <button id="deleteApiBtn" title="åˆ é™¤API" class="btn-primary">x</button>
                    <button id="addApiBtn" title="æ·»åŠ API" class="btn-primary">+</button>
                    <button id="ApiBtn-Other" title="Other" class="btn-primary">...</button>
                </div>
                <div id="apiError" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="file-list card">
                <h3>
                    <span>åª’ä½“æ–‡ä»¶åˆ—è¡¨</span>
                    <span id="loadingIndicator" style="display:none;">åŠ è½½ä¸­...</span>
                </h3>
                <div id="fileItems">
                    <div class="empty-state">è¯·é€‰æ‹©APIå¹¶åˆ·æ–°åˆ—è¡¨</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†èƒŒæ™¯é®ç½© -->
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <!-- æ·»åŠ APIæ¨¡æ€æ¡† -->
    <div class="modal-box" id="apiModal">
        <div class="modal-box-top">
            <div class="modal-box-title">æ·»åŠ API</div>
            <button class="modal-close" id="modalCloseBtn">Ã—</button>
        </div>
        <div class="modal-box-content">
            <input type="text" id="newApiInput" placeholder="è¾“å…¥API URL" style="flex:1;">
            <button id="modalAddBtn" class="btn-primary">æ·»åŠ </button>
        </div>
    </div>
    
    <script src="./api.js"></script>
    <script src="./storage.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentApi = './api.php';
        let currentMediaInfo = null;
        let isCoverVisible = true;

        // DOMå…ƒç´ 
        const mediaElement = document.getElementById('mediaElement');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeDisplay = document.getElementById('currentTime');
        const durationDisplay = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const playbackRate = document.getElementById('playbackRate');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const fileItemsContainer = document.getElementById('fileItems');
        const apiSelector = document.getElementById('apiSelector');
        const refreshApiBtn = document.getElementById('refreshApiBtn');
        const deleteApiBtn = document.getElementById('deleteApiBtn');
        const newApiInput = document.getElementById('newApiInput');
        const addApiBtn = document.getElementById('addApiBtn');
        const otherApiBtn = document.getElementById('ApiBtn-Other');
        const coverArt = document.getElementById('coverArt');
        const coverLayer = document.getElementById('coverLayer');
        const coverPlaceholder = document.getElementById('coverPlaceholder');
        const toggleCoverBtn = document.getElementById('toggleCoverBtn');
        const mediaTitle = document.getElementById('mediaTitle');
        const mediaMeta = document.getElementById('mediaMeta');
        const id3Info = document.getElementById('id3Info');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const apiError = document.getElementById('apiError');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨
                await storageManager.init();
                
                // ä» list.json åŠ è½½é»˜è®¤ API
                await loadDefaultApiFromJson();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                
                // åŠ è½½ API åˆ—è¡¨
                await loadApiList();
                
                // åŠ è½½æ’­æ”¾å†å²ï¼ˆå¯é€‰ï¼‰
                const history = await storageManager.getPlayHistory(10);
                console.log('æ’­æ”¾å†å²:', history);
                
                // åŠ è½½è®¾ç½®
                const lastApi = await storageManager.getSetting('lastApi', './api.php');
                if (lastApi) {
                    apiSelector.value = lastApi;
                    currentApi = lastApi;
                    await refreshFileList();
                }
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });

        // ä» list.json åŠ è½½é»˜è®¤ API
        async function loadDefaultApiFromJson() {
            try {
                const response = await fetch('list.json');
                const data = await response.json();
                
                if (data.api && Array.isArray(data.api)) {
                    const existingApis = await storageManager.getAllApis();
                    
                    for (const apiUrl of data.api) {
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        const exists = existingApis.some(api => api.url === apiUrl);
                        if (!exists) {
                            await storageManager.addApi(apiUrl, `é»˜è®¤API (${apiUrl})`);
                        }
                    }
                }
            } catch (error) {
                console.log('list.jsonåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®é»˜è®¤API');
                // æ·»åŠ å†…ç½®é»˜è®¤API
                const existingApis = await storageManager.getAllApis();
                const defaultApiExists = existingApis.some(api => api.url === './api.php');
                if (!defaultApiExists) {
                    await storageManager.addApi('./api.php', 'é»˜è®¤ API (api.php)');
                }
            }
        }

        // åŠ è½½ API åˆ—è¡¨
        async function loadApiList() {
            try {
                const apis = await storageManager.getAllApis();
                
                // æ¸…ç©ºé€‰æ‹©å™¨
                apiSelector.innerHTML = '';
                
                if (apis.length === 0) {
                    // å¦‚æœæ²¡æœ‰APIï¼Œæ·»åŠ é»˜è®¤
                    await storageManager.addApi('./api.php', 'é»˜è®¤ API (api.php)');
                    const newApis = await storageManager.getAllApis();
                    populateApiSelector(newApis);
                } else {
                    populateApiSelector(apis);
                }
            } catch (error) {
                console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', error);
                showError('åŠ è½½APIåˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        function populateApiSelector(apis) {
            apiSelector.innerHTML = '';
            
            apis.forEach(api => {
                const option = document.createElement('option');
                option.value = api.url;
                option.textContent = api.name || api.url;
                option.selected = api.url === currentApi;
                apiSelector.appendChild(option);
            });
        }

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        async function refreshFileList() {
            const apiUrl = apiSelector.value;
            if (!apiUrl) return;
            
            currentApi = apiUrl;
            loadingIndicator.style.display = 'block';
            fileItemsContainer.innerHTML = '';
            
            try {
                // ä¿å­˜å½“å‰é€‰æ‹©çš„APIåˆ°è®¾ç½®
                await storageManager.setSetting('lastApi', apiUrl);
                
                const data = await fetchFileList(apiUrl);
                
                loadingIndicator.style.display = 'none';
                
                if (data.error) {
                    fileItemsContainer.innerHTML = `<div class="error-message">é”™è¯¯: ${data.error}</div>`;
                    return;
                }
                
                if (!data.files || data.files.length === 0) {
                    fileItemsContainer.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°åª’ä½“æ–‡ä»¶</div>';
                    return;
                }
                
                displayFileItems(data.files);
            } catch (error) {
                loadingIndicator.style.display = 'none';
                fileItemsContainer.innerHTML = `<div class="error-message">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨é¡¹ç›®
        function displayFileItems(files) {
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.path = file.path;
                
                const icon = document.createElement('div');
                icon.className = 'file-icon';
                icon.innerHTML = file.type === 'audio' ? 'ğŸµ' : 'ğŸ¬';
                
                const name = document.createElement('div');
                name.className = 'file-name';
                name.textContent = file.name;
                
                fileItem.appendChild(icon);
                fileItem.appendChild(name);
                
                fileItem.addEventListener('click', () => {
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    fileItem.classList.add('active');
                    
                    playMediaFile(file.path, file.name);
                    
                    fetchAndDisplayMediaInfo(file.path);
                });
                
                fileItemsContainer.appendChild(fileItem);
            });
        }

        // æ’­æ”¾åª’ä½“æ–‡ä»¶
        async function playMediaFile(filePath, fileName) {
            try {
                const url = getMediaFileUrl(currentApi, filePath);
                console.log('æ’­æ”¾åª’ä½“æ–‡ä»¶:', url);
                
                mediaElement.src = url;
                
                await mediaElement.play();
                playPauseBtn.innerHTML = '<span class="btn-icon">â¸</span>';
                
                // æ·»åŠ åˆ°æ’­æ”¾å†å²
                await storageManager.addPlayHistory(filePath, fileName);
                
                // å¦‚æœæ˜¯éŸ³é¢‘ï¼Œæ˜¾ç¤ºå°é¢ï¼›å¦‚æœæ˜¯è§†é¢‘ï¼Œéšè—å°é¢
                if (currentMediaInfo && currentMediaInfo.type === 'audio') {
                    coverLayer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                showError('æ’­æ”¾å¤±è´¥: ' + error.message);
            }
        }

        // è·å–åª’ä½“ä¿¡æ¯
        async function fetchAndDisplayMediaInfo(filePath) {
            try {
                const data = await fetchMediaInfo(currentApi, filePath);
                
                if (data.error) {
                    console.error('è·å–åª’ä½“ä¿¡æ¯å¤±è´¥:', data.error);
                    return;
                }
                
                currentMediaInfo = data;
                updateMediaInfoDisplay(data);
                
                // è·å–å°é¢
                await fetchAndDisplayCover(data.path);
                
                // è·å–ID3ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶ï¼‰
                /*
                if (data.type === 'audio') {
                    await fetchID3Info(data.path);
                } else {
                    id3Info.innerHTML = '';
                }
                */
            } catch (error) {
                console.error('è·å–åª’ä½“ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // è·å–å°é¢
        async function fetchAndDisplayCover(filePath) {
            console.log('è·å–å°é¢:', filePath);
            
            // é‡ç½®å°é¢æ˜¾ç¤º
            coverArt.style.display = 'none';
            coverPlaceholder.style.display = 'block';
            coverArt.src = '';
            
            // å¦‚æœæœ‰ä¹‹å‰çš„Blob URLï¼Œé‡Šæ”¾å®ƒ
            if (coverArt.src && coverArt.src.startsWith('blob:')) {
                URL.revokeObjectURL(coverArt.src);
            }
            
            try {
                const blob = await fetchCover(currentApi, filePath);
                
                if (blob && blob.size > 0) {
                    const url = URL.createObjectURL(blob);
                    coverArt.src = url;
                    coverArt.style.display = 'block';
                    coverPlaceholder.style.display = 'none';
                    
                    // å°é¢åŠ è½½æˆåŠŸå’Œå¤±è´¥çš„å¤„ç†
                    coverArt.onload = () => {
                        console.log('å°é¢å›¾ç‰‡åŠ è½½æˆåŠŸ');
                        // å¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶ï¼Œæ˜¾ç¤ºå°é¢å±‚
                        if (currentMediaInfo && currentMediaInfo.type === 'audio') {
                            coverLayer.classList.remove('hidden');
                        }
                    };
                    
                    coverArt.onerror = () => {
                        console.error('å°é¢å›¾ç‰‡åŠ è½½å¤±è´¥');
                        coverArt.style.display = 'none';
                        coverPlaceholder.style.display = 'block';
                    };
                } else {
                    throw new Error('å°é¢æ•°æ®ä¸ºç©º');
                }
            } catch (error) {
                console.log('è·å–å°é¢å¤±è´¥:', error.message);
                coverArt.style.display = 'none';
                coverPlaceholder.style.display = 'block';
            }
        }

        // è·å–ID3ä¿¡æ¯
        async function fetchID3Info(filePath) {
            try {
                const data = await fetchID3Info(currentApi, filePath);
                
                if (data && !data.error) {
                    // æ˜¾ç¤ºID3ä¿¡æ¯
                    let id3Html = '';
                    if (data.title) id3Html += `<div><strong>æ ‡é¢˜:</strong> ${data.title}</div>`;
                    if (data.artist) id3Html += `<div><strong>è‰ºæœ¯å®¶:</strong> ${data.artist}</div>`;
                    if (data.album) id3Html += `<div><strong>ä¸“è¾‘:</strong> ${data.album}</div>`;
                    if (data.year) id3Html += `<div><strong>å¹´ä»½:</strong> ${data.year}</div>`;
                    if (data.genre) id3Html += `<div><strong>æµæ´¾:</strong> ${data.genre}</div>`;
                    
                    id3Info.innerHTML = id3Html;
                } else {
                    id3Info.innerHTML = '';
                }
            } catch (error) {
                console.log('è·å–ID3ä¿¡æ¯å¤±è´¥:', error.message);
                id3Info.innerHTML = '';
            }
        }

        // æ›´æ–°åª’ä½“ä¿¡æ¯æ˜¾ç¤º
        function updateMediaInfoDisplay(info) {
            mediaTitle.textContent = info.name;
            
            const sizeMB = (info.size / (1024 * 1024)).toFixed(2);
            
            let durationText = '--';
            if (info.duration) {
                durationText = formatTime(info.duration);
            }
            
            mediaMeta.textContent = `${info.type.toUpperCase()} | ${sizeMB} MB | ${durationText}`;
        }

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            apiError.textContent = message;
            apiError.style.display = 'block';
            setTimeout(() => {
                apiError.style.display = 'none';
            }, 5000);
        }

        // æ¨¡æ€æ¡†åŠŸèƒ½
        function showModal() {
            const modal = document.getElementById('apiModal');
            const backdrop = document.getElementById('modalBackdrop');
            modal.style.display = 'block';
            backdrop.style.display = 'block';
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('newApiInput').value = '';
        }

        function hideModal() {
            const modal = document.getElementById('apiModal');
            const backdrop = document.getElementById('modalBackdrop');
            modal.style.display = 'none';
            backdrop.style.display = 'none';
        }

        // æ·»åŠ API
        async function addApi() {
            const url = newApiInput.value.trim();
            if (!url) {
                showError('è¯·è¾“å…¥API URL');
                return;
            }
            
            try {
                await storageManager.addApi(url, url);
                newApiInput.value = '';
                await loadApiList();
                hideModal();
                console.log('APIæ·»åŠ æˆåŠŸ');
            } catch (error) {
                console.error('æ·»åŠ APIå¤±è´¥:', error);
                if (error.name === 'ConstraintError') {
                    showError('è¯¥APIå·²å­˜åœ¨');
                } else {
                    showError('æ·»åŠ APIå¤±è´¥: ' + error.message);
                }
            }
        }

        // åˆ é™¤å½“å‰é€‰ä¸­çš„API
        async function deleteCurrentApi() {
            const selectedApi = apiSelector.value;
            if (selectedApi === './api.php') {
                showError('ä¸èƒ½åˆ é™¤é»˜è®¤API');
                return;
            }
            
            try {
                await storageManager.deleteApiByUrl(selectedApi);
                await loadApiList();
                currentApi = './api.php';
                await refreshFileList();
                console.log('APIåˆ é™¤æˆåŠŸ');
            } catch (error) {
                console.error('åˆ é™¤APIå¤±è´¥:', error);
                showError('åˆ é™¤APIå¤±è´¥: ' + error.message);
            }
        }

        // ä¿®å¤è¿›åº¦æ¡ç‚¹å‡»è·³è½¬åŠŸèƒ½
        function setupProgressBarClick() {
            progressContainer.addEventListener('click', (e) => {
                // ç¡®ä¿åª’ä½“å·²åŠ è½½ä¸”æœ‰æ—¶é•¿
                if (!mediaElement.src || isNaN(mediaElement.duration) || mediaElement.duration <= 0) {
                    console.log('åª’ä½“æœªåŠ è½½å®Œæˆï¼Œæ— æ³•è·³è½¬');
                    return;
                }
                
                const rect = progressContainer.getBoundingClientRect();
                // è®¡ç®—ç‚¹å‡»ä½ç½®åœ¨è¿›åº¦æ¡ä¸Šçš„ç™¾åˆ†æ¯”
                const clickPosition = (e.clientX - rect.left) / rect.width;
                // ç¡®ä¿ç™¾åˆ†æ¯”åœ¨0-1ä¹‹é—´
                const percent = Math.max(0, Math.min(1, clickPosition));
                // è®¡ç®—å¯¹åº”çš„æ’­æ”¾æ—¶é—´
                const newTime = percent * mediaElement.duration;
                
                console.log(`è·³è½¬åˆ°: ${newTime.toFixed(2)} ç§’ (${percent.toFixed(2)}%)`);
                
                // è®¾ç½®æ–°çš„æ’­æ”¾æ—¶é—´
                mediaElement.currentTime = newTime;
                
                // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                progressBar.style.width = `${percent * 100}%`;
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ’­æ”¾/æš‚åœæ§åˆ¶
            playPauseBtn.addEventListener('click', () => {
                if (mediaElement.paused) {
                    mediaElement.play();
                    playPauseBtn.innerHTML = '<span class="btn-icon">â¸</span>';
                } else {
                    mediaElement.pause();
                    playPauseBtn.innerHTML = '<span class="btn-icon">â–¶</span>';
                }
            });
            
            // åˆ‡æ¢å°é¢æ˜¾ç¤º/éšè—
            toggleCoverBtn.addEventListener('click', () => {
                isCoverVisible = !isCoverVisible;
                if (isCoverVisible) {
                    coverLayer.classList.remove('hidden');
                } else {
                    coverLayer.classList.add('hidden');
                }
            });
            
            // è¿›åº¦æ¡æ›´æ–°
            mediaElement.addEventListener('timeupdate', () => {
                // ç¡®ä¿æœ‰æœ‰æ•ˆçš„æ—¶é•¿
                if (mediaElement.duration && mediaElement.duration > 0) {
                    const progress = (mediaElement.currentTime / mediaElement.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                    currentTimeDisplay.textContent = formatTime(mediaElement.currentTime);
                }
            });
            
            // è®¾ç½®è¿›åº¦æ¡ç‚¹å‡»äº‹ä»¶
            setupProgressBarClick();
            
            // éŸ³é‡æ§åˆ¶
            volumeSlider.addEventListener('input', (e) => {
                mediaElement.volume = e.target.value;
            });
            
            // æ’­æ”¾é€Ÿåº¦æ§åˆ¶
            playbackRate.addEventListener('change', (e) => {
                mediaElement.playbackRate = e.target.value;
            });
            
            // å…¨å±æ§åˆ¶
            fullscreenBtn.addEventListener('click', () => {
                if (mediaElement.requestFullscreen) {
                    mediaElement.requestFullscreen();
                } else if (mediaElement.webkitRequestFullscreen) {
                    mediaElement.webkitRequestFullscreen();
                } else if (mediaElement.msRequestFullscreen) {
                    mediaElement.msRequestFullscreen();
                }
            });
            
            // APIé€‰æ‹©å˜åŒ–
            apiSelector.addEventListener('change', () => {
                refreshFileList();
            });
            
            // åˆ·æ–°APIæŒ‰é’®
            refreshApiBtn.addEventListener('click', () => {
                refreshFileList();
            });
            
            // åˆ é™¤APIæŒ‰é’®
            deleteApiBtn.addEventListener('click', deleteCurrentApi);
            
            // å…¶ä»–æŒ‰é’®ï¼ˆæš‚æ—¶æ²¡æœ‰åŠŸèƒ½ï¼‰
            otherApiBtn.addEventListener('click', () => {
                console.log('å…¶ä»–æŒ‰é’®è¢«ç‚¹å‡»');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–åŠŸèƒ½
            });
            
            // æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('addApiBtn').addEventListener('click', showModal);
            document.getElementById('modalCloseBtn').addEventListener('click', hideModal);
            document.getElementById('modalBackdrop').addEventListener('click', hideModal);
            document.getElementById('modalAddBtn').addEventListener('click', addApi);
            
            // æ¨¡æ€æ¡†å†…æŒ‰Enteræ·»åŠ API
            document.getElementById('newApiInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addApi();
                }
            });
            
            // é˜»æ­¢æ¨¡æ€æ¡†å†…å®¹ç‚¹å‡»æ—¶å…³é—­æ¨¡æ€æ¡†
            document.getElementById('apiModal').addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // åˆå§‹åŒ–æŒç»­æ—¶é—´æ˜¾ç¤º
            mediaElement.addEventListener('loadedmetadata', () => {
                if (mediaElement.duration && mediaElement.duration > 0) {
                    durationDisplay.textContent = formatTime(mediaElement.duration);
                    
                    // è§†é¢‘åŠ è½½å®Œæˆåéšè—å°é¢
                    if (currentMediaInfo && currentMediaInfo.type === 'video') {
                        coverLayer.classList.add('hidden');
                    }
                }
            });
            
            // åª’ä½“ç»“æŸäº‹ä»¶
            mediaElement.addEventListener('ended', () => {
                playPauseBtn.innerHTML = '<span class="btn-icon">â–¶</span>';
            });
            
            // åª’ä½“åŠ è½½é”™è¯¯å¤„ç†
            mediaElement.addEventListener('error', () => {
                console.error('åª’ä½“åŠ è½½é”™è¯¯');
                showError('åª’ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç½‘ç»œè¿æ¥');
            });
        }
    </script>
</body>
</html>